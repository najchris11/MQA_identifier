name: CMake Build

on:
  push:
    branches: [ "master", "main" ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v3

    - name: Install Dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libflac++-dev libogg-dev

    - name: Install Dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install flac libogg pkg-config

    - name: Install Dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
        C:\vcpkg\bootstrap-vcpkg.bat
        C:\vcpkg\vcpkg.exe install libflac:x64-windows-static libogg:x64-windows-static
        C:\vcpkg\vcpkg.exe integrate install
      shell: powershell

    - name: Configure CMake (Windows)
      if: runner.os == 'Windows'
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake -DVCPKG_TARGET_TRIPLET=x64-windows-static
      shell: powershell

    - name: Configure CMake (Unix)
      if: runner.os != 'Windows'
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release
      shell: bash

    - name: Build
      run: cmake --build build --config Release

    - name: Test CLI Binary (Windows)
      if: runner.os == 'Windows'
      run: |
        if (Test-Path "build/Release/MQA_identifier.exe") {
          Write-Output "Binary found at build/Release/MQA_identifier.exe"
          & "build/Release/MQA_identifier.exe" --help
        } elseif (Test-Path "build/MQA_identifier.exe") {
          Write-Output "Binary found at build/MQA_identifier.exe"
          & "build/MQA_identifier.exe" --help
        } else {
          Write-Output "Error: Binary not found!"
          exit 1
        }
      shell: powershell

    - name: Test CLI Binary (Unix)
      if: runner.os != 'Windows'
      run: |
        if [ -f "build/MQA_identifier" ]; then
          echo "Binary found at build/MQA_identifier"
          ./build/MQA_identifier --help
        else
          echo "Error: Binary not found!"
          exit 1
        fi
      shell: bash

    - name: Prepare Artifacts (Unix)
      if: runner.os != 'Windows'
      run: |
        mkdir -p release_bin
        cp build/MQA_identifier release_bin/MQA_identifier-${{ runner.os }}
      shell: bash

    - name: Prepare Artifacts (Windows)
      if: runner.os == 'Windows'
      run: |
        New-Item -ItemType Directory -Force -Path release_bin
        if (Test-Path "build/Release/MQA_identifier.exe") {
          Copy-Item "build/Release/MQA_identifier.exe" "release_bin/MQA_identifier-Windows.exe"
        } else {
          Copy-Item "build/MQA_identifier.exe" "release_bin/MQA_identifier-Windows.exe"
        }
      shell: powershell

    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: binary-${{ matrix.os }}
        path: release_bin/*
        if-no-files-found: error

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: binary-*
          merge-multiple: true

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: artifacts/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
