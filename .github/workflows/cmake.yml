name: CMake Build

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - uses: actions/checkout@v3

    - name: Install Dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libflac++-dev libogg-dev

    - name: Install Dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install flac libogg pkg-config

    - name: Install Dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        git clone https://github.com/microsoft/vcpkg.git C:\vcpkg
        C:\vcpkg\bootstrap-vcpkg.bat
        C:\vcpkg\vcpkg.exe install libflac:x64-windows libogg:x64-windows
        C:\vcpkg\vcpkg.exe integrate install
      shell: powershell

    - name: Configure CMake (Windows)
      if: runner.os == 'Windows'
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=C:/vcpkg/scripts/buildsystems/vcpkg.cmake
      shell: powershell

    - name: Configure CMake (Unix)
      if: runner.os != 'Windows'
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release
      shell: bash

    - name: Build
      run: cmake --build build --config Release

    - name: Test CLI Binary (Windows)
      if: runner.os == 'Windows'
      run: |
        if (Test-Path "build/Release/MQA_identifier.exe") {
          Write-Output "Binary found at build/Release/MQA_identifier.exe"
          & "build/Release/MQA_identifier.exe" --help
        } elseif (Test-Path "build/MQA_identifier.exe") {
          Write-Output "Binary found at build/MQA_identifier.exe"
          & "build/MQA_identifier.exe" --help
        } else {
          Write-Output "Error: Binary not found!"
          exit 1
        }
      shell: powershell

    - name: Test CLI Binary (Unix)
      if: runner.os != 'Windows'
      run: |
        if [ -f "build/MQA_identifier" ]; then
          echo "Binary found at build/MQA_identifier"
          ./build/MQA_identifier --help
        else
          echo "Error: Binary not found!"
          exit 1
        fi
      shell: bash
